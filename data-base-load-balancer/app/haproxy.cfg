# File: haproxy.cfg

global
    # Use a high concurrency limit for connection pooling/load balancing
    maxconn 4096
    log /dev/log    local0 notice
    daemon

defaults
    log global
    mode tcp
    # 5 seconds to connect to a server
    timeout connect 5s
    # 50 seconds inactivity time on the client side
    timeout client 50s
    # 50 seconds inactivity time on the server side
    timeout server 50s

# Frontend: Listens for incoming application connections
frontend postgres_reads
    # Binds to all network interfaces on the standard PostgreSQL port
    bind *:5432
    default_backend read_replicas

# Backend: Defines the pool of PostgreSQL replica servers
backend read_replicas
    # Set the load balancing algorithm
    # roundrobin: Cycles through servers evenly (good for simple distribution)
    # leastconn: Sends traffic to the server with the fewest active connections
    balance leastconn
    
    # Configure health checks for TCP connections
    # This ensures only active and running replicas receive traffic
    option tcp-check 
    # Send a small byte to trigger a response check
    tcp-check send-binary 0d0a 
    
    # Define your PostgreSQL read replicas (using Docker service names as hosts)
    # check: Enables health checking
    # inter 1s: Check every 1 second
    # rise 2: Consider server up after 2 successful checks
    # fall 3: Consider server down after 3 failed checks
    server db-slave-01 db-slave-01:5432 check port 5432 inter 1s rise 2 fall 3
    server db-slave-02 db-slave-02:5432 check port 5432 inter 1s rise 2 fall 3

# Optional: Add an HAProxy statistics page for monitoring
listen stats
    bind *:8080
    stats enable
    stats uri /haproxy_stats
    stats realm Haproxy\ Statistics
    stats auth user:password # Change these credentials!